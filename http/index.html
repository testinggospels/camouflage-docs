<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>HTTP - Camoflage Service Virtualization</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "HTTP";
        var mkdocs_page_input_path = "http.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Camoflage Service Virtualization
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Camoflage Service Virtualization</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../getting-started/">Getting Started</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../helpers/">Helpers</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">HTTP</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#available-methods">Available methods</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#gethelpers-helpers">getHelpers = (): Helpers</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#loadconfigfromjsonconfigfilepath-string-void">loadConfigFromJson(configFilePath: string): void</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#setserveroptionshttpoptions-httpserveroptions-void">setServerOptionsHttp(options: http.ServerOptions): void</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#setserveroptionshttpsoptions-httpsserveroptions-void">setServerOptionsHttps(options: https.ServerOptions): void</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#setserveroptionshttp2options-spdyserverserveroptions-void">setServerOptionsHttp2(options: spdy.server.ServerOptions): void</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#setupcachewithoptionsoptions-apicacheoptions-void">setupCacheWithOptions(options: apicache.Options): void</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#setupcorswithoptionscorsoptions-corscorsoptions-void">setupCorsWithOptions(corsOptions: cors.CorsOptions): void</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#setupvalidationwithoptions-validationopts-openapivalidatoropts-void">setupValidationWithOptions = (validationOpts: OpenApiValidatorOpts): void</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#setupcompressionwithoptions-compressionopts-compressionoptions-void">setupCompressionWithOptions = (compressionOpts: CompressionOptions): void</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#addhook-route-string-event-onrequest-beforeresponse-afterresponse-fn-camoflagehook-void">addHook = (route: string, event: "onRequest" | "beforeResponse" | "afterResponse", fn: CamoflageHook): void</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#start-void">start(): void</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#stop-void">stop(): void</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#restart-void">restart(): void</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#hooks">Hooks</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#onrequest">onRequest</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#beforeresponse">beforeResponse</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#afterresponse">afterResponse</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#camoflage-http-configuration">Camoflage Http Configuration</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#folder-structure">Folder structure</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#get-request-to-helloworld">GET Request to /hello/world</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#get-request-to-useruseridwalletwalletid">GET Request to /user/:userId/wallet/:walletId</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#camoflage-http-helpers">Camoflage HTTP Helpers</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#capture-helper">capture Helper</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#file-helper">file Helper</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#state-helper">state Helper</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#usage-in-cypress">Usage in Cypress</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#what-data-to-put-in-mock-files">What data to put in .mock files</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#line-breaks">Line breaks</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#request-matching">Request Matching</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#request-matching-using-headers">Request Matching using headers</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#request-model">Request model</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#response-delays">Response Delays</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#openapi-conversion">OpenAPI Conversion</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#openapi-validation">OpenAPI Validation</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#compression">Compression</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../grpc/">GRPC</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Camoflage Service Virtualization</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">HTTP</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="http">HTTP</h1>
<p>HTTP module of Camoflage lets you mock your backends based on <strong>http, https and http2</strong> protocols. You can create a Camoflage http object from <code>CamoflageHttp</code> class and configure it to serve mocks for your incoming requests.</p>
<p>Start by installing required dependencies</p>
<pre><code class="language-bash">npm i @camoflage/helpers @camoflage/http
</code></pre>
<ul>
<li>You can create the Camoflage object without any parameters, and load the required options as needed</li>
</ul>
<pre><code class="language-javascript">import CamoflageHttp from &quot;@camoflage/http&quot;;

const camoflageHttp: CamoflageHttp = new CamoflageHttp();

camoflageHttp.loadConfigFromJson(&quot;./config.json&quot;);
camoflageHttp.setServerOptions(options);
camoflageHttp.setSecureServerOptions(options);
camoflageHttp.setupCacheWithOptions(options);
camoflageHttp.setupCorsWithOptions(options);

camoflageHttp.start();
</code></pre>
<ul>
<li>Or you can create the Camoflage object with the options</li>
</ul>
<pre><code class="language-javascript">import CamoflageHttp, { CamoflageHttpConfig } from &quot;@camoflage/http&quot;;
import type http from &quot;http&quot;;
import type https from &quot;https&quot;;
import type apicache from &quot;apicache&quot;;
import type cors from &quot;cors&quot;;

const config: CamoflageHttpConfig = {};
const httpOptions: http.ServerOptions = {};
const httpsOptions: https.ServerOptions = {};
const cacheOptions: apicache.Options = {};
const corsOptions: cors.Options = {};

const camoflageHttp: CamoflageHttp = new CamoflageHttp(config, httpOptions, httpsOptions, cacheOptions, corsOptions);
camoflageHttp.start();
</code></pre>
<h2 id="available-methods">Available methods</h2>
<h6 id="gethelpers-helpers"><em>getHelpers = (): Helpers</em></h6>
<p>When you create a CamoflageHttp object, it automatically creates an instance of helpers. You can use <code>getHelpers()</code> to get a reference to this helpers object. This is useful when you want add custom helpers that are specific to your requirements.</p>
<pre><code class="language-javascript">import Helpers from &quot;@camoflage/helpers&quot;;

const helpers: Helpers = camoflageHttp.getHelpers();

helpers.addHelper(&quot;ping&quot;, (context: any) =&gt; {
  return &quot;pong&quot;;
});

camoflageHttp.start();
</code></pre>
<p>You can take a look at how inbuilt helpers have been created, in case you want to understand how custom helpers can be created. Refer to the <a href="UPDATE THIS">helper source code</a>.</p>
<h6 id="loadconfigfromjsonconfigfilepath-string-void"><em>loadConfigFromJson(configFilePath: string): void</em></h6>
<p>While you can include your config as part of your code and ensure the types yourself, you may at times want to maintain the configuration for your Camoflage server separate from the application code. This is usually a good practice from maintainability point of view, or even practical if you want to maintain multiple config files for different usecases.</p>
<p><code>loadConfigFromJson</code> lets you load a config via a .json file. You don't need to worry about validating your config file, Camoflage takes care of validating your config and prints relevant errors which help you fix your config files, if you miss something.</p>
<h6 id="setserveroptionshttpoptions-httpserveroptions-void"><em>setServerOptionsHttp(options: http.ServerOptions): void</em></h6>
<p>Depending on your use case, you might want to set additional options. Use <code>setServerOptionsHttp2</code> to pass those options to Camoflage server. Read more about the available options in the official <a href="https://nodejs.org/api/http.html#httpcreateserveroptions-requestlistener">documentation</a></p>
<h6 id="setserveroptionshttpsoptions-httpsserveroptions-void"><em>setServerOptionsHttps(options: https.ServerOptions): void</em></h6>
<p>In case you are creating an https server, you would need to use <code>setServerOptionsHttps</code> to provide the necessary credentials. You can use it to add other <a href="https://nodejs.org/api/https.html#httpscreateserveroptions-requestlistener">available options</a> as well to your https servers.</p>
<h6 id="setserveroptionshttp2options-spdyserverserveroptions-void"><em>setServerOptionsHttp2(options: spdy.server.ServerOptions): void</em></h6>
<p>In case you are creating an http2 server, you would need to use <code>setServerOptionsHttps</code> to provide the necessary credentials. You can use it to add other <a href="https://www.npmjs.com/package/spdy#options">available options</a> as well to your http2 servers.</p>
<h6 id="setupcachewithoptionsoptions-apicacheoptions-void"><em>setupCacheWithOptions(options: apicache.Options): void</em></h6>
<p>Camoflage HTTP uses, <code>apicache</code> to configure a cache middleware for your mocks. By default, the cache is saved in memory and you can provide a ttl in seconds via config. However in case you want more control over the options, you can fine tune the settings using <code>setupCacheWithOptions</code>.</p>
<p>Following example shows how you can cache with redis instead of in memory.</p>
<pre><code class="language-bash">npm i redis
</code></pre>
<pre><code class="language-javascript">import redis from &quot;redis&quot;;
import type apicache from &quot;apicache&quot;;

let cacheOptions: apicache.Options = {
  redisClient: redis.createClient(),
  respectCacheControl: true,
  statusCodes: {
    exclude: [401, 403, 404],
    include: [200],
  },
  // more options
};

camoflageHttp.setupCacheWithOptions(cacheOptions);
camoflageHttp.start();
</code></pre>
<p>You can refer to <a href="https://www.npmjs.com/package/apicache#available-options-first-value-is-default">apicache documentation</a> for more details on the available options and how to configure them.</p>
<h6 id="setupcorswithoptionscorsoptions-corscorsoptions-void"><em>setupCorsWithOptions(corsOptions: cors.CorsOptions): void</em></h6>
<p>Camoflage uses <code>cors</code> middleware to configure cors for your mocks. By default, cors is enabled for all origins and methods, however you can control this by providing Camoflage a corsOptions before you start the server.</p>
<pre><code class="language-javascript">import type cors from &quot;cors&quot;;

const corsOptions: cors.Options = {
  origin: [&quot;http://localhost:3000&quot;, &quot;http://instrukti.com/&quot;],
  methods: &quot;GET,POST&quot;,
};
camoflageHttp.setupCorsWithOptions(corsOptions);
camoflageHttp.start();
</code></pre>
<p>Read more about available options on <a href="https://www.npmjs.com/package/cors#configuration-options">cors documentation</a>.</p>
<h6 id="setupvalidationwithoptions-validationopts-openapivalidatoropts-void"><em>setupValidationWithOptions = (validationOpts: OpenApiValidatorOpts): void</em></h6>
<p>Allows you to setup validations using an Open API 3 specification. Read more on the usage in the <a href="#openapi-validation">OpenAPI Validation</a> section.</p>
<h6 id="setupcompressionwithoptions-compressionopts-compressionoptions-void"><em>setupCompressionWithOptions = (compressionOpts: CompressionOptions): void</em></h6>
<p>Allows you to setup compression options provided by <a href="https://www.npmjs.com/package/compression#options">compression middleware</a>. Read more on usage in the <a href="#compression">compression</a> section.</p>
<h6 id="addhook-route-string-event-onrequest-beforeresponse-afterresponse-fn-camoflagehook-void"><em>addHook = (route: string, event: "onRequest" | "beforeResponse" | "afterResponse", fn: CamoflageHook): void</em></h6>
<p>Apart from the Camoflage helpers, ability to create custom helpers, Camoflage allows you to add hooks to specific routes. You can add hooks to listen to certain events and manipulate the request/response as you wish.</p>
<p>Available hooks are:</p>
<ol>
<li><strong>onRequest</strong>: <code>onRequest</code> hooks are executed as soon as Camoflage recieves the request. You can use <code>onRequest</code> hooks to intercept the incoming request. You can either <strong>make some changes to your incoming request object</strong> and then let Camoflage run the response builder on the modified request, or <strong>bypass the Camoflage response builder entirely</strong> and send the response from within the hook itself without refering to any mock files.</li>
<li><strong>beforeResponse</strong>: <code>beforeResponse</code> hooks are executed right before Camoflage is about to send the response. <code>beforeResponse</code> hooks are useful when you want Camoflage response builder to use the provided mock file to build a response, however you want to modify the response before it's sent.</li>
<li><strong>afterResponse</strong>: <code>afterResponse</code> hooks are executed once Camoflage has sent the response. <code>afterResponse</code> hooks is useful for logging or other such activities.</li>
</ol>
<p>In the following section, you'll see how we can configure and use these hooks.</p>
<h6 id="start-void"><em>start(): void</em></h6>
<p>Self explanatory. Starts the Camoflage http server.</p>
<h6 id="stop-void"><em>stop(): void</em></h6>
<p>Self explanatory. Stops the Camoflage http server.</p>
<h6 id="restart-void"><em>restart(): void</em></h6>
<p>Self explanatory. Restarts the Camoflage http server.</p>
<h2 id="hooks">Hooks</h2>
<h4 id="onrequest"><code>onRequest</code></h4>
<p>In the following example, we'll see how can we use <code>onRequest</code> hook to intercept the incoming request:</p>
<pre><code class="language-javascript">camoflageHttp.addHook(&quot;/user/:userId/wallet/:walletId&quot;, &quot;onRequest&quot;, (req, res) =&gt; {
  console.log(&quot;Hello from hook&quot;, req.route.path); // You can do some logging
  res.set(&quot;Sent-From&quot;, &quot;onRequestHook&quot;); // You can set some headers
  // You can check some conditions
  if (req.param.userId === 1) {
    // If the condition passes, you can choose to bypass Camoflage entirely by sending the response from within the hook
    res.set(&quot;Content-Type&quot;, &quot;application/json&quot;);
    const body = {
      message: &quot;Sent from onRequestHook&quot;,
    };
    res.status(200).send(JSON.stringify(body));
  }
  // Or you can do nothing and let Camoflage take over after you are done modifying the request/response objects
});
</code></pre>
<h4 id="beforeresponse"><code>beforeResponse</code></h4>
<p>Similarily you can use <code>beforeResponse</code>, to intercept and manipulate the responses generated by Camoflage response builder</p>
<pre><code class="language-javascript">camoflageHttp.addHook(&quot;/user/:userId/wallet/:walletId&quot;, &quot;beforeResponse&quot;, (req, res, camoflageResponse: CamoflageResponse | undefined) =&gt; {
  if (camoflageResponse) console.log(camoflageResponse);
  res.set(&quot;Added-In-Hook&quot;, &quot;SomeHeader&quot;);
});
</code></pre>
<h4 id="afterresponse"><code>afterResponse</code></h4>
<p>Finally, you can use <code>afterResponse</code> hooks to measure time or log some messages as shown below</p>
<pre><code class="language-javascript">let time = 0;
let startTime = 0;
camoflageHttp.addHook(&quot;/user/:userId/wallet/:walletId&quot;, &quot;onRequest&quot;, (req, res) =&gt; {
  startTime = Date.now();
  console.log(&quot;Hello from hook&quot;, req.route.path);
});
camoflageHttp.addHook(&quot;/user/:userId/wallet/:walletId&quot;, &quot;afterResponse&quot;, (req, res) =&gt; {
  time = Date.now() - startTime;
  console.log(time);
  time = 0;
  startTime = 0;
});
</code></pre>
<h2 id="camoflage-http-configuration">Camoflage Http Configuration</h2>
<p>You can provide following configuration options in your <code>config.json</code> file and load it to Camoflage before you start the server</p>
<pre><code class="language-json">{
  &quot;log&quot;: {
    &quot;enable&quot;: true, // enables or disables the logs entirely
    &quot;level&quot;: &quot;trace&quot;, // if enable=true, sets the log level. Available options are &quot;fatal&quot;, &quot;error&quot;, &quot;warn&quot;, &quot;info&quot;, &quot;debug&quot;, &quot;trace&quot;
    &quot;disableRequestLogs&quot;: true // if not disabled, each incoming request will be logged.
  },
  &quot;http&quot;: {
    &quot;enable&quot;: true, // enables or disables http server
    &quot;port&quot;: 8080 // port on which http server would be available
  },
  &quot;https&quot;: {
    &quot;enable&quot;: false, // enables or disables https server
    &quot;port&quot;: 8443 // port on which https server would be available
  },
  &quot;http2&quot;: {
    &quot;enable&quot;: false, // enables or disables http2 server
    &quot;port&quot;: 9443 // port on which http2 server would be available
  },
  &quot;monitoring&quot;: true, // if enabled, provides a /monitoring endpoint with some dashboards for monitoring
  &quot;cache&quot;: {
    &quot;enable&quot;: true, // enables or disables cache
    &quot;timeInSeconds&quot;: 5 // if enabled, sets cache ttl to 5 seconds
  },
  &quot;enableCors&quot;: true, // enables or disables cors
  &quot;mocksDir&quot;: &quot;./mocks&quot; // location of the directory where your mocks live.
}
</code></pre>
<h2 id="folder-structure">Folder structure</h2>
<p>The way you organize your directories inside the <code>mocksDir</code>, determine how your endpoints will be available. Following examples will help you understand the folder structure you need to maintain. We assume that you have configured your <code>mocksDir</code> as <code>./mocks</code> in following examples</p>
<h3 id="get-request-to-helloworld">GET Request to /hello/world</h3>
<ul>
<li>Create a directory <code>./mocks/hello/world</code>.</li>
<li>Create a <code>GET.mock</code> file inside it with your required response.</li>
</ul>
<pre><code class="language-javascript">HTTP/1.1 200 OK
X-Provided-By: CamoflageHttp
Content-Type: application/json

{
    &quot;hello&quot;: &quot;world&quot;
}
</code></pre>
<h3 id="get-request-to-useruseridwalletwalletid">GET Request to /user/:userId/wallet/:walletId</h3>
<ul>
<li>Create a directory <code>/user/:userId/wallet/:walletId</code></li>
<li>Create a <code>GET.mock</code> file inside it with your required response</li>
</ul>
<pre><code class="language-javascript">HTTP/1.1 200 OK
Content-Type: application/json

{
  &quot;userId&quot;: {{capture from='path' key='userId'}},
  &quot;walletId&quot;: {{capture from='path' key='walletId'}},
  &quot;createdAt&quot;: &quot;{{now format='epoch'}}&quot;,
}
</code></pre>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Notice the use of <code>helpers</code> in the above mock. Alongwith the inbuilt <code>now</code> helper, Camoflage http module provides some additional helpers, <code>capture</code> being one of them. In the following section, you can read more about additional helpers that specific to http module.</p>
</div>
<p>Similarly you can create PUT.mock, DELETE.mock etc in your intended path as required by your mocked endpoint.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you are coming from the previous version of Camoflage, note that we have dropped support for wildcards i.e. __ / double underscores. They were primarily intended to be used for dynamic path params which are now handled the way express handles them, which makes it more robust and easy to understand.</p>
</div>
<h2 id="camoflage-http-helpers">Camoflage HTTP Helpers</h2>
<p>In addition to the available helpers that come with <code>@camoflage/helpers</code> module, Camoflage http module provides some protocol specific helpers.</p>
<h3 id="capture-helper"><code>capture</code> Helper</h3>
<p>Usage:</p>
<ul>
<li><strong>{{capture from='query' key='firstName'}}</strong> - Pretty self-explanatory, but if your endpoint looks like <code>/hello/world?firstName=John&amp;lastName=Wick</code>. And your response is <code>{"message": "Hello Wick, John"}</code>, you can make the response dynamic by formatting your response as</li>
</ul>
<pre><code class="language-json">{
  &quot;message&quot;: &quot;Hello {{capture from='query' key='lastName'}}, {{capture from='query' key='firstName'}}&quot;
}
</code></pre>
<ul>
<li><strong>{{capture from='cookies' key='mycookie'}}</strong> - For cookies, you'd need to specify a key to capture a value.</li>
<li><strong>{{capture from='path' key='walletId'}}</strong> - For path, you'd need to specify a key to capture a value.</li>
<li><strong>{{capture from='headers' key='Authorization'}}</strong> - For headers, you'd need to specify a key to capture a value.</li>
<li><strong>{{capture from='body' using='jsonpath' selector='$.lastName'}}</strong> - To capture values from the request body, your options are either <code>using='regex'</code> or <code>using='jsonpath'</code>. Selector will change accordingly.</li>
</ul>
<h3 id="file-helper"><code>file</code> Helper</h3>
<p>Usage:</p>
<p><strong>{{file path='/location/of/the/image/or/text/or/any/file'}}</strong>: If you want to serve a file as a response, maybe an image, or text file, a pdf document, or any type of supported files, use file helper to do so. Content-Type header is decided automatically based on the file type. An example is shown below:</p>
<pre><code class="language-javascript">HTTP/1.1 200 OK

{{file path=&quot;./docs/camoflage.png&quot;}}
</code></pre>
<h3 id="state-helper"><code>state</code> Helper</h3>
<p>Usage: State helper gets the mocked state value using a key send within the cookie header. If no value is found it will use the default context within the block.</p>
<p>For example:</p>
<pre><code class="language-javascript">{
    &quot;has_pending_order&quot;: {{#state key='has-pending-order'}}false{{/state}},
    &quot;cart&quot;: {{#state key='cart'}}[
        {&quot;id&quot;: 999, &quot;name&quot;: &quot;default prod&quot;}
    ]{{/state}}
}
</code></pre>
<p>To set a value just send cookie with a specific prefix.</p>
<pre><code class="language-javascript">const prefix = &quot;mocked-state&quot;;
const key = &quot;has-pending-order&quot;;
setCookie(`${prefix}-has-pending-order`, &quot;true&quot;);
setCookie(`${prefix}-cart`, '[{id: 1, name: &quot;prod1&quot;}, {id: 2, name: &quot;prod2&quot;}]');
</code></pre>
<h4 id="usage-in-cypress">Usage in Cypress</h4>
<p>If you use Camouglage with <a href="https://www.cypress.io/">Cypress</a> you could add the following custom command to make life easier.</p>
<pre><code class="language-javascript">/**
 * Custom cypress command to set a mocked state
 */
Cypress.Commands.add(&quot;setState&quot;, (key: string, value: unknown) =&gt; {
  cy.setCookie(`mocked-state-${key}`, typeof value === &quot;string&quot; ? value : JSON.stringify(value));
});
</code></pre>
<p>Then in your tests</p>
<pre><code class="language-javascript">cy.setState(&quot;has_pending_order&quot;, true);
cy.setState(&quot;cart&quot;, [
  { id: 1, name: &quot;prod1&quot; },
  { id: 2, name: &quot;prod2&quot; },
]);
</code></pre>
<h2 id="what-data-to-put-in-mock-files">What data to put in .mock files</h2>
<p>Camoflage expects a raw HTTP Response to be placed in the .mock files. Please refer to this <a href="https://en.wikipedia.org/wiki/HTTP_message_body">Wikipedia</a> page, if you are not sure what the response looks like.</p>
<p>Each mock file can have the HTTP Responses in following manner:</p>
<ul>
<li>One response per .mock file.</li>
<li>Multiple responses in one .mock file with conditions defined to help Camoflage decide which response should be sent under what conditions. (Read Handlebars section for more)</li>
<li>Multiple responses separated by Camoflage's delimiter i.e. "====" (four equals). Camoflage will pick one response at random and send it to the client. An example of this can be found here</li>
</ul>
<p>The data you want in your mock file can be easily fetched using a curl command with -i -X flags as shown in the example below.</p>
<pre><code class="language-bash">curl -i -X GET https://jsonplaceholder.typicode.com/users/1 &gt; GET.mock
</code></pre>
<p>Running this command, gives you a <code>GET.mock</code> file with following content. Modify it according to your requirement and place it in the location <code>./mocks/users/:userId</code>, and you have successfully mocked jsonplaceholder API.</p>
<pre><code class="language-javascript">HTTP/1.1 200 OK
date: Sat, 17 Apr 2021 05:21:51 GMT
content-type: application/json; charset=utf-8
content-length: 509
set-cookie: __cfduid=ddf6b687a745fea6ab343400b5dfe9f141618636911; expires=Mon, 17-May-21 05:21:51 GMT; path=/; domain=.typicode.com; HttpOnly; SameSite=Lax
x-powered-by: Express
x-ratelimit-limit: 1000
x-ratelimit-remaining: 998
x-ratelimit-reset: 1612952731
vary: Origin, Accept-Encoding
access-control-allow-credentials: true
cache-control: max-age=43200
pragma: no-cache
expires: -1
x-content-type-options: nosniff
etag: W/&quot;1fd-+2Y3G3w049iSZtw5t1mzSnunngE&quot;
via: 1.1 vegur
cf-cache-status: HIT
age: 14578
accept-ranges: bytes
cf-request-id: 097fe04d2c000019d97db7d000000001
expect-ct: max-age=604800, report-uri=&quot;https://report-uri.cloudflare.com/cdn-cgi/beacon/expect-ct&quot;
report-to: {&quot;endpoints&quot;:[{&quot;url&quot;:&quot;https:\/\/a.nel.cloudflare.com\/report?s=%2FkpNonG0wnuykR5xxlGXKBUxm5DN%2BI1PpQ0ytmiw931XaIVBNqZMJLEr0%2F3kDTrOhbX%2FCCPZtI4iuU3V%2F07wO5uwqov0d4c12%2Fcdpiz7TIFqzGkr7DwUrzt40CLH&quot;}],&quot;max_age&quot;:604800,&quot;group&quot;:&quot;cf-nel&quot;}
nel: {&quot;max_age&quot;:604800,&quot;report_to&quot;:&quot;cf-nel&quot;}
server: cloudflare
cf-ray: 6413365b7e9919d9-SIN
alt-svc: h3-27=&quot;:443&quot;; ma=86400, h3-28=&quot;:443&quot;; ma=86400, h3-29=&quot;:443&quot;; ma=86400

{
  &quot;id&quot;: 1,
  &quot;name&quot;: &quot;Leanne Graham&quot;,
  &quot;username&quot;: &quot;Bret&quot;,
  &quot;email&quot;: &quot;Sincere@april.biz&quot;,
  &quot;address&quot;: {
    &quot;street&quot;: &quot;Kulas Light&quot;,
    &quot;suite&quot;: &quot;Apt. 556&quot;,
    &quot;city&quot;: &quot;Gwenborough&quot;,
    &quot;zipcode&quot;: &quot;92998-3874&quot;,
    &quot;geo&quot;: {
      &quot;lat&quot;: &quot;-37.3159&quot;,
      &quot;lng&quot;: &quot;81.1496&quot;
    }
  },
  &quot;phone&quot;: &quot;1-770-736-8031 x56442&quot;,
  &quot;website&quot;: &quot;hildegard.org&quot;,
  &quot;company&quot;: {
    &quot;name&quot;: &quot;Romaguera-Crona&quot;,
    &quot;catchPhrase&quot;: &quot;Multi-layered client-server neural-net&quot;,
    &quot;bs&quot;: &quot;harness real-time e-markets&quot;
  }
}
</code></pre>
<p>Another, easier, approach to create mocks is by installing the <a href="https://marketplace.visualstudio.com/items?itemName=humao.rest-client">REST Client VS Code Extension</a> and using it to fetch the required data for mocks.</p>
<ul>
<li>Launch VS Code and install "REST Client" Extension by Huachao Mao or simply open the link above.</li>
<li>Create a .http file in your project to document your actual http endpoints and make the requests.</li>
<li>Visit <a href="https://github.com/Huachao/vscode-restclient">REST Client github repository</a> for more details on usage</li>
</ul>
<h3 id="line-breaks">Line breaks</h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Camoflage by default looks for the OS specific line breaks. For example, if you are on MacOS or Unix based systems, the default line break/new line is <code>\n</code>, whereas on windows it's <code>\r\n</code>. This is known to cause issues if your development environment and testing environment are different for Camoflage. For example, if you have created your mock file on a windows machine and uploaded it to a Camoflage server running on linux, your mocks might not work as expected. Or in case your text editor's line break settings do not match your OS default line break, you might not get an expected response.</p>
<p>Though Camoflage detects new lines used in the file irrespective of the OS default, you should not face any issues. However, if you face any issues where you are getting a blank response or any unexpected response, please create an issue attaching your log files. REMEMBER TO REMOVE SENSITIVE DATA, IF ANY, FROM YOUR LOGS.</p>
</div>
<h2 id="request-matching">Request Matching</h2>
<p>There are scenarios when you would need to change your response based on some conditions met by fields on request objects. For example, if the end user passes an Authorization header, you'd want to send a 200 OK response if not you'd want to send a 401 Unauthorized response.</p>
<p>To do so you can utilize the beauty of handlebars. Simply provide an if else condition and you are good to go. Let's understand how to do this in the following example:</p>
<p>You expect the user to call the endpoint <code>/hello</code> in two ways.</p>
<ol>
<li>By simple making a GET request to <code>/hello</code>; Or</li>
<li>By adding a query parameter name in the GET request to <code>/hello</code>. i.e. <code>/hello?name=John</code></li>
</ol>
<p>Based on how the user calls the API, you'd want to send different responses. Let's see how we can achieve the desired result.</p>
<p>Start by creating a <code>GET.mock</code> file at the location <code>./mocks/hello</code>. Paste the following content in the mock file.</p>
<pre><code class="language-javascript">{{#if request.query.name}}
HTTP/1.1 200 OK
X-Provided-By: CamoflageHttp
Content-Type: application/json

{
    &quot;greeting&quot;: &quot;Hello {{capture from='query' key='name'}}&quot;,
    &quot;phone&quot;: {{randomValue length=10 type='NUMERIC'}},
    &quot;dateOfBirth&quot;: &quot;{{now format='MM/DD/YYYY'}}&quot;,
    &quot;test&quot;: &quot;{{randomValue}}&quot;
}
{{else}}
HTTP/1.1 200 OK
X-Provided-By: CamoflageHttp
Content-Type: application/json

{
    &quot;greeting&quot;: &quot;Hello World&quot;,
    &quot;phone&quot;: {{randomValue length=10 type='NUMERIC'}},
    &quot;dateOfBirth&quot;: &quot;{{now format='MM/DD/YYYY'}}&quot;,
    &quot;test&quot;: &quot;{{randomValue}}&quot;
}
{{/if}}
</code></pre>
<p>In the example above, we have provided two responses that Camoflage can pick from, one with <code>greeting: "Hello World"</code>, and another with <code>greeting: "Hello John"</code>. In the first line of the mock <code>{{#if request.query.name}}</code>, we are checking for the condition, if there exists a query parameter called <code>name</code>. And that's it. If your request is made with the query param <code>name</code>, Camoflage will respond with first response, if not then the 2nd second response is what you get. And the value of <code>name</code> can be anything. We are using <code>capture</code> helper to help us make our response dynamic.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>if</code> and <code>unless</code> helpers are provided by handlebarjs, which don't have comparison capabilities. These helpers only check if the provided value is truthy or falsy. i.e. you can not do something like this: <code>{{#if something = something}}</code>. For comparisons, you'd need to use <code>is</code> helper. See Helpers page for example.</p>
</div>
<h3 id="request-matching-using-headers">Request Matching using headers</h3>
<p>You can use the approach shown above to perform request matching with query, path params and cookies. Use <code>request.query.name</code> or <code>request.params.name</code> or <code>request.cookies.something</code> as required.</p>
<p>However for headers and body, we need to follow a slightly different approach. In the following example, we are using <code>capture</code> helper to capture a specific header value which then can be passed to other helpers like <code>is</code> or <code>if</code>.</p>
<pre><code class="language-javascript">{{#if (capture from='headers' key='Authorization') }}
HTTP/1.1 200 OK
Content-Type: application/json

{
    &quot;response&quot;: &quot;response if auth header is present.&quot;
}
{{else}}
HTTP/1.1 401 Unauthorized
Content-Type: application/json

{
    &quot;response&quot;: &quot;response if no auth header present.&quot;
}
{{/if}}
</code></pre>
<p>If you want to validate a given header against a specific value, the mock file would be as shown below:</p>
<pre><code class="language-javascript">{{#is (capture from='headers' key='Authorization') 'Basic c2h1YmhlbmR1Om1hZGh1a2Fy' }}
HTTP/1.1 200 OK
Content-Type: application/json

{
    &quot;response&quot;: &quot;response if auth header is present.&quot;
}
{{else}}
HTTP/1.1 401 Unauthorized
Content-Type: application/json

{
    &quot;response&quot;: &quot;response if no auth header present.&quot;
}
{{/is}}
</code></pre>
<h3 id="request-model">Request model</h3>
<p>Request object made available by Camoflage is simply an instance of express request object for a given incoming request. Following are the properties/objects available on the request object which can be used in request matching or to extract information out of the request.</p>
<ul>
<li>request.baseUrl</li>
<li>request.body</li>
<li>request.cookies</li>
<li>request.method</li>
<li>request.originalUrl</li>
<li>request.path</li>
<li>request.protocol</li>
<li>request.query</li>
<li>request.body</li>
</ul>
<p>Refer to <a href="http://expressjs.com/en/4x/api.html#req">Express Documentation</a> for more information on each of these properties.</p>
<h2 id="response-delays">Response Delays</h2>
<p>You can add a Response-Delay header in raw response placed in your .mock file.</p>
<p>For example, if you'd like to simulate a delay of 2 seconds for <code>GET /hello</code> endpoint, contents of your <code>./mocks/hello/GET.mock</code> file would be as follows:</p>
<pre><code class="language-javascript">HTTP/1.1 200 OK
X-Requested-By: Shubhendu Madhukar
Content-Type: application/json
Response-Delay: 2000

{
    &quot;greeting&quot;: &quot;Hello World&quot;,
    &quot;phone&quot;: {{randomValue length=10 type='NUMERIC'}},
    &quot;dateOfBirth&quot;: &quot;{{now format='MM/DD/YYYY'}}&quot;,
    &quot;test&quot;: &quot;{{randomValue}}&quot;
}
</code></pre>
<p>Additionally you can also simulate a dynamic delay using the {{num_between}} handlebar as follows</p>
<pre><code class="language-javascript">Response-Delay: {{num_between lower=500 upper=600}}
</code></pre>
<h2 id="openapi-conversion">OpenAPI Conversion</h2>
<p>If you have access to the OpenAPI specification for the APIs/Endpoints you want to mock, Camoflage supports the conversion via the <code>camoswag</code> utility.</p>
<ul>
<li>To use <code>camoswag</code>, you would need your OpenAPI specification file in either .json or .yaml format.</li>
<li>You don't need to install <code>camoswag</code> locally on your machine, you can simply run the script using npx.</li>
<li>Run the command: <code>npx camoswag --spec ./swagger.yaml</code> or <code>npx camoswag --spec ./swagger.json</code>. (Replace file location with your spec file location)</li>
<li>If you would like to install camoswag locally, you can do so by running the command: <code>npm i -g camoswag</code>. For conversion use, <code>camoswag --spec ./swagger.yaml</code></li>
<li>This would create a new folder with the name <code>camoflage-${current_timestamp}</code> containing the required folder structure and mock files corresponding to each endpoint defined in your spec file.</li>
<li>You can either delete or modify the dummy responses placed in the mockfiles as per your expectations. Once you are satisfied with the modifications, you can move the contents of the folder to your original <code>mocksDir</code> of your running Camoflage server.</li>
<li>Note that if your spec file doesn't contain a response defined for a given endpoint, <code>camoswag</code> would put the following default response in the mock file.</li>
</ul>
<pre><code class="language-javascript">{
  &quot;message&quot;: &quot;More Configuration Needed&quot;
}
</code></pre>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p><code>camoswag</code> currently supports JSON responses only.</p>
</div>
<h2 id="openapi-validation">OpenAPI Validation</h2>
<p>Camoflage uses <code>express-openapi-validator</code> to enable you to validate your requests/responses against a provided OpenAPI 3 schema.</p>
<p>You can configure validation in two ways.</p>
<ul>
<li><strong>Basic Usage:</strong> You can enable it via config.json. Add following options to you config:</li>
</ul>
<pre><code class="language-json">{
  // Other Camoflage options
  &quot;validation&quot;: {
    &quot;enable&quot;: true,
    &quot;apiSpec&quot;: &quot;./apiSpec.yaml&quot;,
    &quot;validateRequests&quot;: true,
    &quot;validateResponses&quot;: true
  }
}
</code></pre>
<p>Modify the above config as per your requirements, and you are good to go.</p>
<ul>
<li><strong>Advanced Usage:</strong> If you want more control over how to configure validation, you can set the <a href="https://github.com/cdimascio/express-openapi-validator/wiki/Documentation#advanced-usage">supported validation options</a> via the Camoflage method <code>setupValidationWithOptions</code></li>
</ul>
<p>Enable it via config</p>
<pre><code class="language-json">{
  // Other Camoflage options
  &quot;validation&quot;: {
    &quot;enable&quot;: true
  }
}
</code></pre>
<p>And then configure rest of the options as you wish</p>
<pre><code class="language-javascript">camoflageHttp.setupValidationWithOptions({
  apiSpec: &quot;./openapi.yaml&quot;,
  validateRequests: true,
  validateResponses: true,
  // Other options
});
</code></pre>
<h2 id="compression">Compression</h2>
<p>You can optionally enable the compression options via config.json. Once enabled, compression is applied on all the routes, however you can restrict this behaviour using the <code>setupCompressionWithOptions</code> method and <a href="https://www.npmjs.com/package/compression#options">available options</a></p>
<p>Enable compression in config.json</p>
<pre><code class="language-json">{
  // Other Camoflage options
  &quot;compression&quot;: true
}
</code></pre>
<p>Then provide required options</p>
<pre><code class="language-javascript">function shouldCompress(req, res) {
  if (req.headers[&quot;x-no-compression&quot;]) {
    // don't compress responses with this request header
    return false;
  }

  // fallback to standard filter function
  return compression.filter(req, res);
}
camoflageHttp.setupCompressionWithOptions({ filter: shouldCompress });
</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../helpers/" class="btn btn-neutral float-left" title="Helpers"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../grpc/" class="btn btn-neutral float-right" title="GRPC">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../helpers/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../grpc/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
